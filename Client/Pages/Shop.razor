@page "/Shop";
@*@attribute [Authorize(Roles = "Iron Man")]*@
@using System.Net.Sockets
@using BookShop.Client.Data
@using BookShop.Client.Models

<style>
    .card {
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
    max-width: 300px;
    margin: auto;
    text-align: center;
    font-family: arial;
}

.price {
    color: grey;
    font-size: 22px;
}

.card button {
    border: none;
    outline: 0;
    padding: 12px;
    color: white;
    background-color: #000;
    text-align: center;
    cursor: pointer;
    width: 100%;
    font-size: 18px;
}

    .card button:hover {
        opacity: 0.7;
    }

.grid-container {
    display: grid;
    column-gap: 50px;
    gap: 50px;
    grid-template-columns: auto auto auto;
    padding: 10px;
}
</style>


<PageTitle>Index</PageTitle>

<AuthorizeView>
    <Authorized>
        <MudGrid Spacing="5" Justify="Justify.FlexStart">
            <MudItem>
                <MudSelect T="string" ValueChanged="value => Sort(value)" Label="Order by" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="@("All")" />
                    <MudSelectItem Value="@("By Name")"/>
                    <MudSelectItem Value="@("By Author")"/>
                    <MudSelectItem Value="@("By year posted")"/>
                    <MudSelectItem Value="@("By Tag")"/>
                </MudSelect>
            </MudItem>
            @if (Orderby == "By Tag")
            {
                <MudItem>
                    <MudSelect T="string" Label="Order by" AnchorOrigin="Origin.BottomCenter" ValueChanged="value => SortByTag(value)">
                        @foreach (string tag in @tags)
                        {
                            <MudSelectItem Value="@tag"/>
                        }
                    </MudSelect>
                </MudItem>
            }
            <MudItem>
                <MudTextField @bind-Value="serchstring" @onkeydown="Search" Label="Search" Variant="Variant.Outlined" />
            </MudItem>
        </MudGrid>

        <MudGrid Spacing="5" Justify="Justify.Center">
            @foreach (Book i in _books)
            {
                <MudItem>
                    <MudCard>
                        <MudCardMedia Image="book.png" Height="200"/>
                        <MudCardContent>
                            <MudText Typo="Typo.h5">@i.Name</MudText>
                            <MudText Typo="Typo.body2">@i.Author @i.YearPosted</MudText>
                            <MudText Typo="Typo.body2">Описание</MudText>
                            @foreach (string tag in i.Tags.Split(","))
                            {
                                <MudChip Color="Color.Primary" @onclick="() => SortByTag(tag)">@tag</MudChip>
                            }
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Text" Color="Color.Primary" @onclick="() => RemoveBook(i.Name)">Buy</MudButton>
                            <MudButton Variant="Variant.Text" Color="Color.Primary">Details</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    </Authorized>
    <NotAuthorized>
        <img src="https://i.gifer.com/origin/51/51f1ea94effbb251598e67e8522e58f5.gif" />
    </NotAuthorized>
</AuthorizeView>

@code
{
    List<Book> _books = new List<Book>();
    List<Book> _booksInitial = new List<Book>();
    List<string> tags = new List<string>();
    string Orderby = string.Empty;

    void RemoveBook(string name) => _books = _books.Where(x => x.Name != name).ToList();

    public string serchstring = "";

    protected override async Task OnInitializedAsync()
    {
        _books = await BookService.GetAll();
        _booksInitial = _books;
        tags = _books.SelectMany(x => x.Tags.Split(",")).Distinct().ToList();
    }

    void Sort(string by)
    {
        Orderby = by;
        _books = by switch
        {
            "By Name" => _books.OrderBy(x => x.Name).ToList(),
            "By Author" => _books.OrderBy(x => x.Author).ToList(),
            "By year posted" => _books.OrderBy(x => x.YearPosted).ToList(),
            "All" => _booksInitial,
            _ => _books
        };
        StateHasChanged();
    }

    void SortByTag(string tag)
    {
        _books = _booksInitial.Where(x => x.Tags.Contains(tag)).ToList();
        StateHasChanged();
    }

    void Search()
    {
        _books = _booksInitial.Where(x => x.Name.ToLower().Contains(serchstring.ToLower()) ||
                                              x.Author.ToLower().Contains(serchstring.ToLower()) ||
                                              x.YearPosted.ToLower().Contains(serchstring.ToLower()) ||
                                              x.Tags.ToLower().Contains(serchstring.ToLower())).ToList();
        StateHasChanged();
    }
}


